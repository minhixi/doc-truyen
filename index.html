<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Nghe truy·ªán</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width:900px; margin:auto; }
    input[type="text"]{ width:72%; padding:8px; }
    button{ margin-left:6px; padding:8px 10px; }
    textarea{ width:100%; height:260px; margin-top:12px; padding:10px; box-sizing:border-box; }
    .controls{ margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .status{ margin-top:8px; color:#333; font-size:14px; }
  </style>
</head>
<body>
  <h2>Nghe truy·ªán t·ª´ link</h2>

  <div>
    <input id="storyUrl" type="text" placeholder="D√°n link truy·ªán v√†o ƒë√¢y" />
    <button id="btnFetch">üì• T·∫£i</button>
  </div>

  <textarea id="storyText" placeholder="N·ªôi dung truy·ªán s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y..."></textarea>

  <div class="controls">
    <button id="btnPlay">‚ñ∂ ƒê·ªçc</button>
    <button id="btnStop">‚èπ D·ª´ng</button>
    <label for="speed">T·ªëc ƒë·ªô:</label>
    <input id="speed" type="range" min="0.8" max="1.5" step="0.1" value="1" style="width:110px" />
    <span id="speedVal">1.0</span>
  </div>

  <div class="status" id="status">Tr·∫°ng th√°i: ch·ªù</div>

  <script>
    // Thay b·∫±ng URL Worker c·ªßa b·∫°n
    const WORKER_BASE = "https://truyen-reader.testnetboom07.workers.dev/";

    const btnFetch = document.getElementById("btnFetch");
    const storyUrl = document.getElementById("storyUrl");
    const storyText = document.getElementById("storyText");
    const btnPlay = document.getElementById("btnPlay");
    const btnStop = document.getElementById("btnStop");
    const statusEl = document.getElementById("status");
    const speedEl = document.getElementById("speed");
    const speedVal = document.getElementById("speedVal");

    let chunks = [];
    let currentIndex = 0;
    let audio = null;

    btnFetch.addEventListener("click", async () => {
      const url = storyUrl.value.trim();
      if (!url) { alert("Vui l√≤ng nh·∫≠p link truy·ªán"); return; }
      status("ƒêang t·∫£i n·ªôi dung...");
      try {
        const res = await fetch(`${WORKER_BASE}/?url=${encodeURIComponent(url)}`);
        const data = await res.json();
        storyText.value = data.text || "";
        status("T·∫£i xong ‚Äî s·∫µn s√†ng ƒë·ªÉ ƒë·ªçc");
      } catch (e) {
        status("L·ªói t·∫£i: " + e.message);
      }
    });

    btnPlay.addEventListener("click", () => {
      const text = storyText.value.trim();
      if (!text) { alert("Ch∆∞a c√≥ n·ªôi dung ƒë·ªÉ ƒë·ªçc"); return; }
      startRead(text);
    });

    btnStop.addEventListener("click", () => {
      stopRead();
      status("ƒê√£ d·ª´ng");
    });

    speedEl.addEventListener("input", () => {
      speedVal.innerText = parseFloat(speedEl.value).toFixed(1);
    });

    function startRead(text) {
      stopRead();
      chunks = splitText(text, 500); // c·∫Øt nh·ªè ƒëo·∫°n 500 k√Ω t·ª± ƒë·ªÉ API d·ªÖ x·ª≠ l√Ω
      currentIndex = 0;
      status(`B·∫Øt ƒë·∫ßu ƒë·ªçc (1/${chunks.length})`);
      playNext();
    }

    async function playNext() {
      if (currentIndex >= chunks.length) {
        status("ƒê·ªçc xong");
        return;
      }
      const chunk = chunks[currentIndex];
      status(`ƒêang ƒë·ªçc (ƒëo·∫°n ${currentIndex+1}/${chunks.length})`);
      const api = `${WORKER_BASE}/?tts=${encodeURIComponent(chunk)}`;
      audio = new Audio(api);
      audio.playbackRate = parseFloat(speedEl.value) || 1.0;
      audio.onended = () => {
        currentIndex++;
        setTimeout(playNext, 200);
      };
      audio.onerror = () => {
        currentIndex++;
        setTimeout(playNext, 200);
      };
      audio.play();
    }

    function stopRead() {
      if (audio) { audio.pause(); audio = null; }
      chunks = [];
      currentIndex = 0;
    }

    function splitText(text, maxLen = 500) {
      text = text.replace(/\s+/g, ' ').trim();
      const parts = [];
      while (text.length > maxLen) {
        let idx = text.lastIndexOf(" ", maxLen);
        if (idx === -1) idx = maxLen;
        parts.push(text.slice(0, idx).trim());
        text = text.slice(idx).trim();
      }
      if (text.length) parts.push(text);
      return parts;
    }

    function status(msg) {
      statusEl.innerText = "Tr·∫°ng th√°i: " + msg;
    }
  </script>
</body>
</html>
