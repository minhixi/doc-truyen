<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Nghe truy·ªán</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width:900px; margin:auto; }
    input[type="text"]{ width:72%; padding:8px; }
    button{ margin-left:6px; padding:8px 10px; }
    textarea{ width:100%; height:260px; margin-top:12px; padding:10px; box-sizing:border-box; }
    .controls{ margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .status{ margin-top:8px; color:#333; font-size:14px; }
    label{ font-size:13px; margin-right:6px; }
  </style>
</head>
<body>
  <h2>Nghe truy·ªán t·ª´ link</h2>

  <div>
    <input id="storyUrl" type="text" placeholder="D√°n link truy·ªán v√†o ƒë√¢y (v√≠ d·ª•: https://niemlam.wordpress.com/...)" />
    <button id="btnFetch">üì• T·∫£i</button>
  </div>

  <textarea id="storyText" placeholder="N·ªôi dung truy·ªán s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y..."></textarea>

  <div class="controls">
    <button id="btnPlay">‚ñ∂ ƒê·ªçc</button>
    <button id="btnPause">‚è∏ T·∫°m d·ª´ng</button>
    <button id="btnResume">‚èØ Ti·∫øp t·ª•c</button>
    <button id="btnStop">‚èπ D·ª´ng</button>

    <label for="speed">T·ªëc ƒë·ªô:</label>
    <input id="speed" type="range" min="0.6" max="1.6" step="0.1" value="1" style="width:110px" />
    <span id="speedVal">1.0</span>

    <label for="voiceSelect">Gi·ªçng:</label>
    <select id="voiceSelect" style="min-width:200px"></select>
  </div>

  <div class="status" id="status">Tr·∫°ng th√°i: ch·ªù</div>

  <script>
    // ---- C·∫•u h√¨nh: s·ª≠a WORKER_BASE n·∫øu c·∫ßn ----
    const WORKER_BASE = "https://truyen-reader.testnetboom07.workers.dev/?url=";
    // ------------------------------------------

    const btnFetch = document.getElementById("btnFetch");
    const storyUrl = document.getElementById("storyUrl");
    const storyText = document.getElementById("storyText");
    const btnPlay = document.getElementById("btnPlay");
    const btnPause = document.getElementById("btnPause");
    const btnResume = document.getElementById("btnResume");
    const btnStop = document.getElementById("btnStop");
    const statusEl = document.getElementById("status");
    const speedEl = document.getElementById("speed");
    const speedVal = document.getElementById("speedVal");
    const voiceSelect = document.getElementById("voiceSelect");

    let chunks = [];
    let currentChunkIndex = 0;
    let isPlaying = false;
    let isPaused = false;
    let selectedVoiceURI = null;

    // Fetch story text from Worker
    btnFetch.addEventListener("click", async () => {
      const url = storyUrl.value.trim();
      if (!url) { alert("Vui l√≤ng nh·∫≠p link truy·ªán"); return; }
      status("ƒêang t·∫£i n·ªôi dung...");
      try {
        const api = WORKER_BASE + encodeURIComponent(url);
        const res = await fetch(api, {
          headers: { "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)" }
        });
        if (!res.ok) throw new Error("Server tr·∫£ l·ªói " + res.status);
        const data = await res.json();
        storyText.value = (data && data.text) ? data.text : "";
        status("T·∫£i xong ‚Äî s·∫µn s√†ng ƒë·ªÉ ƒë·ªçc");
      } catch (err) {
        status("L·ªói t·∫£i: " + err.message);
        alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c: " + err.message);
      }
    });

    // Play / Pause / Resume / Stop
    btnPlay.addEventListener("click", () => {
      const text = storyText.value.trim();
      if (!text) { alert("Ch∆∞a c√≥ n·ªôi dung ƒë·ªÉ ƒë·ªçc"); return; }
      startTTS(text);
    });

    btnPause.addEventListener("click", () => {
      if (speechSynthesis.speaking && !speechSynthesis.paused) {
        speechSynthesis.pause();
        isPaused = true;
        status("ƒê√£ t·∫°m d·ª´ng");
      }
    });

    btnResume.addEventListener("click", () => {
      if (speechSynthesis.paused) {
        speechSynthesis.resume();
        isPaused = false;
        status("ƒêang ti·∫øp t·ª•c");
      }
    });

    btnStop.addEventListener("click", () => {
      stopTTS();
      status("ƒê√£ d·ª´ng");
    });

    speedEl.addEventListener("input", () => {
      speedVal.innerText = parseFloat(speedEl.value).toFixed(1);
    });

    // ---- TTS logic: chia ƒëo·∫°n r·ªìi ƒë·ªçc n·ªëi ti·∫øp ----
    function startTTS(text) {
      stopTTS(); // reset tr∆∞·ªõc khi ƒë·ªçc m·ªõi
      chunks = splitText(text, 1500); // k√≠ch th∆∞·ªõc 1500 k√Ω t·ª± / chunk
      currentChunkIndex = 0;
      isPlaying = true;
      isPaused = false;
      status(`B·∫Øt ƒë·∫ßu ƒë·ªçc (ƒëo·∫°n 1/${chunks.length})`);
      speakNextChunk();
    }

    function speakNextChunk() {
      if (!isPlaying) return;
      if (currentChunkIndex >= chunks.length) {
        isPlaying = false;
        status("ƒê·ªçc xong");
        return;
      }

      const chunk = chunks[currentChunkIndex];
      const utter = new SpeechSynthesisUtterance(chunk);
      utter.lang = "vi-VN";
      utter.rate = parseFloat(speedEl.value) || 1.0;
      // g√°n gi·ªçng n·∫øu c√≥
      if (selectedVoiceURI) {
        const voice = speechSynthesis.getVoices().find(v => v.voiceURI === selectedVoiceURI);
        if (voice) utter.voice = voice;
      }

      utter.onend = () => {
        if (!isPlaying) return; // ƒë√£ b·ªã d·ª´ng
        if (!isPaused) {
          currentChunkIndex++;
          status(`ƒêang ƒë·ªçc (ƒëo·∫°n ${currentChunkIndex+1}/${chunks.length})`);
          // nh·ªè delay ƒë·ªÉ tr√°nh v·∫•n ƒë·ªÅ m·ªôt s·ªë browser
          setTimeout(speakNextChunk, 150);
        }
      };

      utter.onerror = (e) => {
        console.error("TTS error:", e);
        currentChunkIndex++;
        setTimeout(speakNextChunk, 200);
      };

      speechSynthesis.speak(utter);
      status(`ƒêang ƒë·ªçc (ƒëo·∫°n ${currentChunkIndex+1}/${chunks.length})`);
    }

    function stopTTS() {
      speechSynthesis.cancel();
      isPlaying = false;
      isPaused = false;
      chunks = [];
      currentChunkIndex = 0;
    }

    // ---- splitText: gi·ªØ c√¢u n·∫øu c√≥ th·ªÉ, c·∫Øt ·ªü d·∫•u ch·∫•m ho·∫∑c space ----
    function splitText(text, maxLen = 1500) {
      text = text.replace(/\s+/g, ' ').trim();
      const parts = [];
      while (text.length > maxLen) {
        let idx = -1;
        const substr = text.slice(0, maxLen);
        // t√¨m v·ªã tr√≠ d·∫•u c√¢u g·∫ßn cu·ªëi c√πng
        const punctRe = /[\.!\?‚Ä¶;„ÄÇÔºÅÔºüÔºå]/g;
        let match;
        while ((match = punctRe.exec(substr)) !== null) { idx = match.index + 1; }
        if (idx === -1) {
          idx = substr.lastIndexOf(' ');
          if (idx === -1) idx = maxLen;
        }
        parts.push(text.slice(0, idx).trim());
        text = text.slice(idx).trim();
      }
      if (text.length) parts.push(text);
      return parts;
    }

    // ---- status helper ----
    function status(msg) { statusEl.innerText = "Tr·∫°ng th√°i: " + msg; }

    // ---- voice list populate ----
    function populateVoices() {
      const voices = speechSynthesis.getVoices();
      voiceSelect.innerHTML = "";
      // ∆∞u ti√™n gi·ªçng vi·ªát n·∫øu c√≥
      const sorted = voices.slice().sort((a,b) => {
        const aVi = a.lang && a.lang.toLowerCase().startsWith("vi") ? -1 : 1;
        const bVi = b.lang && b.lang.toLowerCase().startsWith("vi") ? -1 : 1;
        return aVi - bVi;
      });
      sorted.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.voiceURI;
        opt.text = `${v.name} (${v.lang})`;
        voiceSelect.appendChild(opt);
      });
      // ch·ªçn m·∫∑c ƒë·ªãnh l√† gi·ªçng vi n·∫øu c√≥
      const firstVi = sorted.find(v => v.lang && v.lang.toLowerCase().startsWith("vi"));
      if (firstVi) selectedVoiceURI = firstVi.voiceURI;
      else if (sorted[0]) selectedVoiceURI = sorted[0].voiceURI;
      if (selectedVoiceURI) voiceSelect.value = selectedVoiceURI;
    }

    voiceSelect.addEventListener("change", () => {
      selectedVoiceURI = voiceSelect.value;
    });

    // m·ªôt s·ªë browser t·∫£i voices b·∫•t ƒë·ªìng b·ªô
    populateVoices();
    window.speechSynthesis.onvoiceschanged = populateVoices;

    // N·∫øu m·ªü trang m√† ƒë√£ c√≥ n·ªôi dung, hi·ªÉn th·ªã tr·∫°ng th√°i
    if (storyText.value.trim()) status("S·∫µn s√†ng");
  </script>
</body>
</html>
